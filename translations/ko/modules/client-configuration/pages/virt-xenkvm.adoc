[[virt-xenkvm]]
= Xen 및 KVM을 이용한 가상화

Xen 및 KVM 가상화 클라이언트는 {productname}에서 직접 관리할 수 있습니다.

먼저 {productname} 서버에서 가상 호스트를 설정해야 합니다. 그런 다음, 향후 가상 호스트 및 가상 게스트에 대해 {ay} 또는 {kickstart}를 사용해 자동 설치를 설정할 수 있습니다.

이 섹션에는 가상 게스트 설치 후 이 게스트를 관리하는 방법에 대한 정보도 포함되어 있습니다.



== 호스트 설정

VM 호스트에서 Xen 또는 KVM을 설정하는 방법은 연결된 게스트에서 사용하려는 운영 체제에 따라 달라집니다.

{suse} 운영 체제의 경우 https://documentation.suse.com/sles/15-SP2/html/SLES-all/book-virt.html에서 사용 가능한 SLES 가상화 안내서를 참조하십시오.

{rhel} 운영 체제의 경우 해당 버전의 Red Hat 문서를 참조하십시오.

{productname}는 [systemitem]``libvirt``를 사용해 게스트를 설치하고 관리합니다. 호스트에 [daemon]``libvirtd`` 패키지 설치를 완료한 상태이어야 합니다. 대부분의 경우 대개 기본 설정으로 충분하므로 기본 설정을 조정하지 않아도 됩니다. 하지만 게스트에서 루트가 아닌 사용자로 VNC 콘솔에 액세스하려면 구성을 몇 가지 변경해야 합니다. 이를 설정하는 방법에 대한 자세한 내용은 해당 운영 체제의 관련 문서를 참조하십시오.

{productname} 서버에서 부트스트랩 스크립트가 필요합니다. 부트스트랩 스크립트는 호스트를 위한 활성화 키를 포함해야 합니다. 또한 추가 보안을 위해 GPG 키를 포함하는 것이 좋습니다. 부트스트랩 스크립트 생성에 대한 자세한 내용은 xref:client-configuration:registration-bootstrap.adoc[]을 참조하십시오.

부트스트랩 스크립트가 준비되었으면 호스트에서 실행하여 {productname} 서버로 등록합니다. 클라이언트 등록에 대한 자세한 내용은 xref:client-configuration:registration-overview.adoc[]를 참조하십시오.

Salt 클라이언트의 경우 [systemitem]``가상화 호스트`` 자격을 활성화해야 합니다. 이렇게 하면 VM 변경 사항을 즉시 볼 수 있습니다. 이를 위해서는 {productname} {webui}에서 호스트의 [guimenu]``시스템 정보`` 페이지로 이동하여 [guimenu]``등록 정보`` 탭을 클릭하십시오. 또는 등록 키 수준에서 [systemitem]``가상화 호스트`` 자격을 추가할 수 있습니다. [guimenu]``추가 시스템 유형`` 섹션에서 [guimenu]``가상화 호스트``의 확인란을 선택하고 btn:[등록 정보 업데이트]를 클릭하여 변경 사항을 저장합니다. 다음과 같이 Salt Minion 서비스를 다시 시작하여 변경 사항을 활성화합니다.

----
systemctl restart salt-minion
----

기존 클라이언트의 경우 VM 호스트는 기본적으로 [systemitem]``rhnsd`` 서비스를 사용해 예약된 작업을 확인합니다. 이러한 확인은 네 시간마다 이루어지며, 이를 통해 다수의 클라이언트가 있는 환경에서 로드를 밸런싱합니다. 이로 인해 작업이 수행될 때까지 최대 네 시간의 지연이 발생할 수 있습니다. VM 게스트를 관리하고 있다면 이처럼 긴 지연 시간이 항상 좋은 것은 아닙니다(특히 게스트 재부팅과 같은 작업일 경우). 이 문제를 해결하려면 [systemitem]``rhnsd`` 서비스를 비활성화하고 [daemon]``osad`` 서비스를 활성화하면 됩니다. [daemon]``osad`` 서비스는 jabber 프로토콜을 사용해 명령을 수신하고 명령을 즉시 실행합니다.

[systemitem]``rhnsd`` 서비스를 비활성화하고 [daemon]``osad`` 데몬을 활성화하려면 루트 사용자로 다음 명령을 실행하십시오.

----
service rhnsd stop
service rhnsd disable
----

----
service osad enable
service osad start
----

== 자동 설치


{ay} 또는 {kickstart}를 사용해 Xen 및 KVM 게스트를 자동으로 설치하고 등록할 수 있습니다.

게스트를 등록하려는 VM 호스트와 각 게스트에 활성화 키가 필요합니다. 활성화 키에는 [systemitem]``조달`` 및 [systemitem]``가상화 플랫폼`` 자격이 있어야 합니다. 활성화 키에는 [package]``mgr-virtualization-host`` 및 [package]``mgr-osad`` 패키지에 대한 액세스 권한도 있어야 합니다. 활성화 키 생성에 대한 자세한 내용은 xref:client-configuration:activation-keys.adoc[]를 참조하십시오.

설치 후 {productname}로 게스트를 자동 등록하려면 부트스트랩 스크립트를 생성해야 합니다. 부트스트랩 스크립트 생성에 대한 자세한 내용은 xref:client-configuration:registration-bootstrap.adoc[]을 참조하십시오.

[IMPORTANT]
====
VM 게스트 자동 설치는 기존 클라이언트로 구성된 경우에만 작동합니다. Salt 클라이언트는 {ay} 또는 {kickstart}가 아닌 템플릿 디스크 이미지를 사용해 생성할 수 있습니다.
====



=== 자동 설치 가능한 배포 생성

{productname}에서 클라이언트를 자동 설치하려면 VM 호스트에 자동 설치 가능한 배포를 생성해야 합니다. 마운트한 로컬 또는 원격 디렉토리나 루프 마운트 ISO 이미지에서 배포를 사용할 수 있는 상태로 만들 수 있습니다.

자동 설치 가능한 배포의 구성은 게스트에서 SLES 또는 {rhel} 운영 체제를 사용하고 있는지 여부에 따라 달라집니다. {rhel} 설치를 위한 패키지는 연결된 기본 채널에서 가져옵니다. {suse} 시스템 설치를 위한 패키지는 자동 설치 가능한 배포에서 가져옵니다. 따라서 SLES 시스템의 경우 자동 설치 가능한 배포는 완전한 설치 소스이어야 합니다.

.자동 설치 가능한 배포를 위한 경로
[cols="1,1,1", options="header"]
|===
| 운영 체제 유형 | 커널 위치 | initrd 위치
| {rhel} | [path]``images/pxeboot/vmlinuz``    |  [path]``images/pxeboot/initrd.img``
 | SLES | [path]``boot/<arch>/loader/initrd`` |  [path]``boot/<arch>/loader/linux``
|===

모든 경우 기본 채널이 자동 설치 배포와 일치하는지 확인하십시오.

시작하기 전에 VM 호스트에 사용할 수 있는 설치 미디어가 있는지 확인하십시오. 이러한 설치 미디어는 네트워크 리소스, 로컬 디렉토리 또는 루프 마운트 ISO 이미지에 있을 수 있습니다. 또한 모든 파일 및 디렉토리가 누구나 읽을 수 있는 것인지 확인하십시오.


.절차: 자동 설치 가능한 배포 생성

. {productname} {webui}에서 menu:시스템[자동 설치 > 배포판]으로 이동한 후 btn:[배포 생성]을 클릭합니다.
. [guimenu]``자동 설치 가능한 배포판 생성`` 섹션에서 파라미터를 다음과 같이 적용합니다.
* [guimenu]``배포판 레이블`` 섹션에 배포판의 고유 이름을 입력합니다.
    글자, 숫자, 하이픈(``-``), 마침표(``.``), 밑줄(``_``)만 사용하고, 이름을 구성하는 문자는 다섯 개 이상이어야 합니다.
* [guimenu]``트리 경로`` 필드에 설치 원본의 절대 경로를 입력합니다.
* [guimenu]``기본 채널`` 필드에서 설치 소스와 일치하는 채널을 선택합니다.
    이 채널은 비{suse} 설치에 대해 패키지 소스로 사용됩니다.
* [guimenu]``설치 프로그램 생성`` 필드에서 설치 소스와 일치하는 운영 체제 버전을 선택합니다.
* [guimenu]``커널 옵션`` 필드에 설치를 부팅할 때 커널로 전달될 옵션을 입력합니다.
    [option]``install=`` 파라미터와 [option]``self_update=0 pt.options=self_update``파라미터가 기본적으로 추가됩니다.
* [guimenu]``커널 후 옵션`` 섹션에 처음으로 설치된 시스템을 부팅할 때 커널로 전달될 옵션을 입력합니다.
. btn:[자동 설치 가능한 배포판 생성]을 클릭하여 저장합니다.

자동 설치 가능한 배포판을 생성한 후 menu:시스템[자동 설치 > 배포판]으로 이동하여 편집할 배포판을 선택하고 편집할 수 있습니다.



=== 자동 설치 프로파일 생성 및 업로드

자동 설치 프로파일에는 시스템을 설치하는 데 필요한 모든 설치 및 구성 데이터가 포함되어 있습니다. 설치 완료 후 실행될 스크립트도 포함할 수 있습니다.

{kickstart} profiles can be created using the {productname} {webui}, by navigating to menu:Systems[Autoinstallation > Profiles], clicking btn:[Create New Kickstart File], and following the prompts.

You can also create {ay} or {kickstart} autoinstallation profiles by hand. {suse} provides templates of {ay} installation files that you can use as a starting point for your own custom files. You will find them at https://github.com/SUSE/manager-build-profiles.

If you are using {ay} to install SLES, you also need to include this snippet:

----
<products config:type=\list\>
  <listentry>SLES</listentry>
 </products>
----

* For more on {ay}, see xref:client-configuration:autoinst-profiles.adoc#autoyast[].
* For more on {kickstart}, see xref:client-configuration:autoinst-profiles.adoc#kickstart[], or refer to the Red Hat documentation for your installation.



.절차: 자동 설치 프로파일 업로드

. {productname} {webui}에서 menu:시스템[자동 설치 > 프로파일]로 이동하여 btn:[Kickstart/AutoYaST 파일 업로드]를 클릭합니다.
. [guimenu]``자동 설치 프로파일 생성`` 섹션에서 다음 파라미터를 사용합니다.
* [guimenu]``레이블`` 필드에 프로파일의 고유 이름을 입력합니다.
    글자, 숫자, 하이픈(``-``), 마침표(``.``), 밑줄(``_``)만 사용하고, 이름을 구성하는 문자는 일곱 개 이상이어야 합니다.
* [guimenu]``자동 설치 트리`` 필드에서 앞서 생성한 자동 설치 가능한 배포를 선택합니다.
* [guimenu]``가상화 유형`` 필드에서 해당되는 게스트 유형(예: [parameter]``KVM 가상화 게스트``)을 선택합니다.
    여기에서 [guimenu]``Xen 가상화 호스트``를 선택하지 마십시오.
* 옵션: 자동 설치 프로파일을 수동으로 생성하려면 [guimenu]``파일 내용`` 필드에 프로파일을 직접 입력할 수 있습니다.
    파일을 이미 생성한 경우 [guimenu]``파일 내용`` 필드를 공백으로 두십시오.
* [guimenu]``업로드할 파일`` 필드에서 btn:[파일 선택]을 클릭하고 시스템 대화 상자를 사용해 업로드할 파일을 선택합니다.
    파일 업로드가 완료되면 파일 이름이 [guimenu]``업로드할 파일`` 필드에 표시됩니다.
* 업로드한 파일의 내용이 [guimenu]``파일 내용`` 필드에 표시됩니다.
    편집하려면 직접할 수 있습니다.
. btn:[생성]을 클릭하여 변경 사항을 저장하고 프로파일을 보관합니다.

자동 설치 프로파일을 생성했으면 menu:시스템[자동 설치 > 프로파일]로 이동해 편집하려는 프로파일을 선택하여 편집할 수 있습니다. 원하는 대로 변경한 후 btn:[생성]을 클릭하여 설정을 저장합니다.

[IMPORTANT]
====
기존 {kickstart} 프로파일의 [guimenu]``가상화 유형``을 변경하면 부트로더 및 파티션 옵션이 수정되어 사용자 정의 설정이 덮어쓰기될 수도 있습니다. [guimenu]``파티셔닝`` 탭을 주의 깊게 검토하여 이 설정을 확인한 후에 변경하십시오.
====



=== 게스트를 자동으로 등록


VM 게스트를 자동으로 설치하는 경우 {productname}에 등록되지 않습니다. 게스트가 설치되자마자 자동으로 등록되게 하려면 부트스트랩 스크립트를 호출하고 게스트를 등록하는 자동 설치 프로파일에 섹션을 추가할 수 있습니다.

이 섹션에서는 부트스트랩 스크립트를 기존 {ay} 프로파일에 추가하는 것에 관한 지침을 제공합니다.

부트스트랩 스크립트 생성에 대한 자세한 내용은 xref:client-configuration:registration-bootstrap.adoc[]을 참조하십시오. {kickstart]에 대해 이 작업을 하는 방법에 대한 지침은 해당 설치에 대한 Red Hat 문서를 참조하십시오.

.절차: 부트스트랩 스크립트를 {ay} 프로파일에 추가

. 등록하려는 VM 게스트에 대한 활성화 키를 부트스트랩 스크립트가 포함하는지, 이 키가 [path]``/srv/www/htdocs/pub/bootstrap_vm_guests.sh``의 호스트에 있는지 확인합니다.
. {productname} {webui}에서 menu:시스템[자동 설치 > 프로파일]로 이동하여 이 스크립트를 연결할 {ay} 프로파일을 선택합니다.
. [guimenu]``파일 내용`` 필드에서 이 코드 조각을 파일 끝의 종료 태그 ``</profile>`` 바로 앞에 추가합니다.
    아래 코드 조각의 예시 IP 주소를 {productname} 서버의 정확한 IP 주소로 교체해야 합니다.
+
----
<scripts>
  <init-scripts config:type=\list\>
     <script>
       <interpreter>shell </interpreter>
       <location>
         http://`192.168.1.1`/pub/bootstrap/bootstrap_vm_guests.sh
       </location>
     </script>
   </init-scripts>
 </scripts>
----
+
. menu:업데이트[]를 클릭하여 변경 사항을 저장합니다.

[IMPORTANT]
====
{ay} 프로파일에 ``<scripts>`` 섹션이 이미 포함되어 있는 경우 이 섹션을 추가하지 마십시오. 기존 ``<scripts>`` 섹션 안에 부트스트랩 코드 조각을 배치합니다.
====


=== VM 게스트 자동 설치


모든 것을 설정했으면 VM 게스트 자동 설치를 시작할 수 있습니다.

[IMPORTANT]
====
각 VM 호스트는 한 번에 한 게스트만 설치할 수 있습니다. 두 건 이상의 자동 설치 일정을 잡는 경우 이전 설치가 완료되기 전에 다음번 설치가 시작되지 않도록 시간을 안배해야 합니다. 다른 게스트 자동 설치가 아직 실행 중일 때 게스트 설치가 시작되면 실행 중인 설치가 취소됩니다.
====


. {productname} {webui}에서 menu:시스템[개요]로 이동하여 게스트를 설치하려는 VM 호스트를 선택합니다.
. [guiitem]``가상화`` 탭의 [guimenu]``조달`` 하위 탭으로 이동합니다.
. 사용하려는 자동 설치 프로파일을 선택하고, 게스트에 고유한 이름을 지정합니다.
. 해당되는 경우 프록시를 선택하고 일정을 입력합니다.
. 게스트의 하드웨어 프로파일 및 구성 옵션을 변경하려면 btn:[고급 옵션]을 클릭합니다.
. btn:[자동 설치 일정 잡기 후 완료]를 클릭하여 완료합니다.



== VM 게스트 관리


{productname} {webui}를 사용해 종료, 재시작, CPU 및 메모리 할당 조정 등의 작업을 포함해 VM 게스트를 관리할 수 있습니다.

이를 위해서는 {productname} 서버에 등록된 Xen 또는 KVM VM 호스트가 필요하며 호스트에 [daemon]``libvirtd`` 서비스가 실행 중이어야 합니다. 기존 클라이언트의 경우 {productname} 서버에 설치된 [package]``mgr-cfg-actions`` 패키지도 필요합니다.

{productname} {webui}에서 menu:시스템[시스템 목록]으로 이동하여 관리하려는 게스트의 VM 호스트를 클릭합니다. [guimenu]``가상화`` 탭으로 이동하여 이 호스트에 등록된 모든 게스트를 확인하고 관리 기능에 액세스합니다.

{webui}를 사용한 VM 게스트 관리에 대한 자세한 내용은 xref:reference:systems/system-details/sd-virtualization.adoc[]를 참조하십시오.
