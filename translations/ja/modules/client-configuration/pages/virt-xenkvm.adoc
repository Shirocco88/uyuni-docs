[[virt-xenkvm]]
= XenおよびKVMを使用した仮想化

XenおよびKVMの仮想化クライアントは{productname}で直接管理できます。

まず、{productname}サーバで仮想ホストを設定する必要があります。 今後の仮想ホストおよび仮想ゲストの{ay}または{kickstart}を使用して自動インストールを設定できます。

このセクションでは、インストール後に仮想ゲストを管理する方法についても説明します。



== ホストの設定

VMホストでXenまたはKVMを設定する方法は、関連するゲストで使用するオペレーティングシステムによって決まります。

{suse}オペレーティングシステムについては、https://documentation.suse.com/sles/15-SP2/html/SLES-all/book-virt.htmlでSLES仮想化に関するガイドを参照してください。

{rhel}オペレーティングシステムについては、使用バージョンに応じてRed Hatのドキュメントを参照してください。

{productname}は、[systemitem]``libvirt``を使用してゲストをインストールして管理します。 ホストに[daemon]``libvirtd``パッケージがインストールされている必要があります。 ほとんどの場合、デフォルト設定で十分で、調整する必要はありません。 ただし、ゲストのVNCコンソールに非rootユーザとしてアクセスする場合、設定変更を実行する必要があります。 設定方法の詳細については、ご使用のオペレーティングシステム用のマニュアルを参照してください。

{productname}サーバでブートストラップスクリプトが必要です。 ブートストラップスクリプトには、ホストのアクティベーションキーを含める必要があります。 GPGキーも含めてセキュリティを強化することをお勧めします。 ブートストラップスクリプトの作成については、xref:client-configuration:registration-bootstrap.adoc[]を参照してください。

ブートストラップスクリプトの準備ができたら、ホストで実行し、{productname}サーバに登録します。 クライアントの登録の詳細については、xref:client-configuration:registration-overview.adoc[]を参照してください。

Saltクライアントの場合、[systemitem]``仮想化ホスト``エンタイトルメントを有効にする必要があります。 有効にすると、VMの変更をすぐに表示できます。 そのためには、{productname}の{webui}でホストの［[guimenu]``システムの詳細``］ページで、［[guimenu]``プロパティ``］タブをクリックします。 または、[systemitem]``仮想化ホスト``エンタイトルメントを登録キーレベルで追加できます。 ［[guimenu]``付属エンタイトルメント``］セクションで、［[guimenu]``仮想化ホスト``］にチェックを付け、［btn:[プロパティの更新]］をクリックして変更を保存します。 Salt minionサービスを再起動して変更を有効にします。

----
systemctl restart salt-minion
----

従来のクライアントの場合、デフォルトでは、VMホストは[systemitem]``rhnsd``サービスを使用して、スケジュールされたアクションを確認します。 確認は4時間ごとに実行され、多数のクライアントが存在する環境の負荷を均等化します。 そのため、アクションの実行前に、最大4時間の遅延が発生する可能性があります。 VMゲストを管理している場合、この長時間の遅延は常に(特にゲストの再起動の際には)理想的ではありません。 この問題に対処するには、[systemitem]``rhnsd``サービスを無効にして[daemon]``osad``サービスを有効にできます。 [daemon]``osad``サービスは、jabberプロトコルを使用してコマンドを受け取り、すぐにコマンドを実行します。

[systemitem]``rhnsd``サービスを無効にして[daemon]``osad``デーモンを有効にするには、次のコマンドをrootユーザとして実行します。

----
service rhnsd stop
service rhnsd disable
----

----
service osad enable
service osad start
----

== 自動インストール


{ay}または{kickstart}を使用して、XenおよびKVMのゲストを自動的にインストールして登録できます。

ゲスト登録先のVMホストでアクティベーションキーがそれぞれのゲストで必要です。 アクティベーションキーには、[systemitem]``プロビジョニング``のエンタイトルメントと[systemitem]``仮想化プラットフォーム``のエンタイトルメントが必要です。 アクティベーションキーは、[package]``mgr-virtualization-host``パッケージおよび[package]``mgr-osad``パッケージにもアクセスできる必要があります。 アクティベーションキーの作成の詳細については、xref:client-configuration:activation-keys.adoc[]を参照してください。

インストール後に{productname}でゲストを自動的に登録する場合、ブートストラップスクリプトを作成する必要があります。 ブートストラップスクリプトの作成については、xref:client-configuration:registration-bootstrap.adoc[]を参照してください。

[IMPORTANT]
====
VMゲストの自動インストールは、従来のクライアントとして設定されている場合のみ機能します。 Saltクライアントはテンプレートディスクイメージを使用して作成できます。{ay}または{kickstart}を使用して作成することはできません。
====



=== 自動インストール可能なディストリビューションの作成

{productname}からクライアントを自動インストールできる自動インストール可能なディストリビューションをVMに作成する必要があります。 ディストリビューションは、マウントされたローカルディレクトリやリモートディレクトリから使用できたり、ループマウントされたISOイメージで使用できます。

自動インストール可能なディストリビューションの設定は、SLESまたは{rhel}オペレーティングシステムをゲストで使用しているかどうかによって異なります。 {rhel}インストールのパッケージは、関連するベースチャンネルからフェッチされます。 {suse}システムをインストールするパッケージは、自動インストール可能なディストリビューションからフェッチされます。 したがって、SLESシステムでは、自動インストール可能なディストリビューションは、完全なインストールソースである必要があります。

.自動インストール可能なディストリビューションのパス
[cols="1,1,1", options="header"]
|===
| オペレーティングシステムの種類 | カーネルの場所 | initrdの場所
| {rhel} | [path]``images/pxeboot/vmlinuz``    |  [path]``images/pxeboot/initrd.img``
 | SLES | [path]``boot/<arch>/loader/initrd`` |  [path]``boot/<arch>/loader/linux``
|===

すべてのケースで、ベースチャンネルが自動インストール可能なディストリビューションと一致していることを確認してください。

始める前に、使用しているVMホストでインストールメディアを使用できることを確認してください。 これは、ネットワークリソース上、ローカルディレクトリ内、またはループマウントされたISOイメージ内にある場合があります。 また、すべてのファイルおよびディレクトリが全世界で読み取ることができることを確認してください。


.手順: 自動インストール可能なディストリビューションの作成

. {productname}の{webui}で、menu:システム[自動インストール > ディストリビューション]に移動し、［btn:[ディストリビューションの作成]］をクリックします。
. ［[guimenu]``自動インストール可能なディストリビューションの作成``］セクションで、次のパラメータを使用します。
* ［[guimenu]``ディストリビューションラベル``］セクションに、ディストリビューションの固有の名前を入力します。
    半角の英字、数字、ハイフン(``-``)、ピリオド(``.``)、および下線(``_``)のみを使用し、5文字以上にしてください。
* ［[guimenu]``ツリーパス``］フィールドに、インストールソースへの絶対パスを入力します。
* ［[guimenu]``ベースチャンネル``］フィールドで、インストールソースと一致するチャンネルを選択します。
    このチャンネルは、非{suse}インストール環境用のパッケージソースとして使用されます。
* ［[guimenu]``インストーラ生成``］フィールドで、インストールソースと一致するオペレーティングシステムのバージョンを選択します。
* ［[guimenu]``カーネルオプション``］フィールドに、インストールでブート時にカーネルに渡すオプションを入力します。
    [option]``install=``パラメータおよび[option]``self_update=0 pt.options=self_update``パラメータはデフォルトで追加されます。
* インストールしたシステムを初めてブートするときにカーネルに渡すオプションを［[guimenu]``カーネルの後のオプション``］セクションに入力します。
. ［btn:[自動インストール可能なディストリビューションの作成]］をクリックして保存します。

自動インストール可能なディストリビューションを作成するとき、これを編集できます。そのためには、menu:システム[自動インストール > ディストリビューション]に移動し、編集するディストリビューションを選択します。



=== 自動インストールプロファイルの作成およびアップロード

自動インストールプロファイルには、システムをインストールするために必要なインストールデータおよび設定データがすべて含まれています。 インストール完了後に実行するスクリプトを含めることもできます。

{kickstart} profiles can be created using the {productname} {webui}, by navigating to menu:Systems[Autoinstallation > Profiles], clicking btn:[Create New Kickstart File], and following the prompts.

You can also create {ay} or {kickstart} autoinstallation profiles by hand. {suse} provides templates of {ay} installation files that you can use as a starting point for your own custom files. You will find them at https://github.com/SUSE/manager-build-profiles.

If you are using {ay} to install SLES, you also need to include this snippet:

----
<products config:type="list">
  <listentry>SLES</listentry>
 </products>
----

* For more on {ay}, see xref:client-configuration:autoinst-profiles.adoc#autoyast[].
* For more on {kickstart}, see xref:client-configuration:autoinst-profiles.adoc#kickstart[], or refer to the Red Hat documentation for your installation.



.プロシージャ: 自動インストールプロファイルのアップロード

. {productname}の{webui}で、menu:システム[自動インストール > プロファイル]に移動し、［btn:[キックスタート/Autoyastファイルをアップロード]］をクリックします。
. ［[guimenu]``自動インストールプロファイルを作成``］セクションで、次のパラメータを使用します。
* ［[guimenu]``ラベル``］フィールドにプロファイルの一意の名前を入力します。
    半角の英字、数字、ハイフン(``-``)、ピリオド(``.``)、および下線(``_``)のみを使用し、7文字以上にしてください。
* ［[guimenu]``自動インストールツリー``］フィールドで、前に作成した自動インストール可能なディストリビューションを選択します。
* ［[guimenu]``仮想化タイプ``］フィールドで、関連するゲストの種類を選択します([parameter]``KVM仮想化ゲスト``など)。
    ここでは、［[guimenu]``Xen仮想化ホスト``］を選択しないでください。
* オプション: 自動インストールプロファイルを手動で作成する場合、［[guimenu]``ファイルの内容``］フィールドに直接入力できます。
    ファイルを作成済みの場合、［[guimenu]``ファイルの内容``］フィールドを空白のままにします。
* ［[guimenu]``アップロードするファイル``］フィールドで、［btn:[Choose File（ファイルの選択）]］をクリックし、システムダイアログを使用して、アップロードするファイルを選択します。
    ファイルが正常にアップロードされると、ファイル名が［[guimenu]``アップロードするファイル``］フィールドに表示されます。
* アップロードしたファイルの内容が［[guimenu]``ファイルの内容``］フィールドに表示されます。
    編集する必要がある場合、直接編集できます。
. ［btn:[作成]］をクリックして変更を保存し、プロファイルを保存します。

自動インストールプロファイルを作成するとき、これを編集できます。そのためには、menu:システム[自動インストール > プロファイル]に移動し、編集するプロファイルを選択します。 ［btn:[作成]］をクリックして、必要な変更を行い、設定を保存します。

[IMPORTANT]
====
既存の{kickstart}プロファイルの［[guimenu]``仮想化タイプ``］を変更する場合、ブートローダおよびパーティションのオプションも変更する場合があり、カスタム設定を上書きすることもあります。 ［[guimenu]``パーティション設定``］タブを注意深く確認して、変更前にこれらの設定を確認してください。
====



=== ゲストを自動的に登録する


VMゲストを自動的にインストールするとき、{productname}には登録されません。 ゲストをインストールしてすぐに自動的に登録する場合、ブートストラップスクリプトを呼び出してゲストを登録する自動インストールプロファイルにセクションを追加できます。

このセクションでは、ブートストラップスクリプトを既存の{ay}プロファイルに追加する手順について説明します。

ブートストラップスクリプトの作成の詳細については、xref:client-configuration:registration-bootstrap.adoc[]を参照してください。 {kickstart]でこの作業を行う方法については、Red Hatのインストール関連ドキュメントを参照してください。

.プロシージャ: ブートストラップスクリプトを{ay}プロファイルに追加する

. 登録するVMゲストのアクティベーションキーがブートストラップスクリプトに含まれていることを確認してください。これはホストの[path]``/srv/www/htdocs/pub/bootstrap_vm_guests.sh``にあります。
. {productname}の{webui}で、menu:システム[自動インストール > プロファイル]に移動し、このスクリプトを関連付ける{ay}プロファイルを選択します。
. ［[guimenu]``ファイルの内容``］フィールドで、次のスニペットをファイルの末尾(``</profile>``タグの直前)に追加します。
    スニペットのIPアドレス例を、使用中の{productname}サーバの正しいIPアドレスに置き換えてください。
+
----
<scripts>
  <init-scripts config:type="list">
     <script>
       <interpreter>shell </interpreter>
       <location>
         http://`192.168.1.1`/pub/bootstrap/bootstrap_vm_guests.sh
       </location>
     </script>
   </init-scripts>
 </scripts>
----
+
. ［menu:更新[]］をクリックして変更を保存します。

[IMPORTANT]
====
{ay}プロファイルに``<scripts>``セクションがすでに含まれている場合、2つ目のセクションを追加しないでください。 既存の``<scripts>``セクション内にブートストラップスニペットを配置します。
====


=== VMゲストの自動インストール


すべての設定が完了したら、VMゲストの自動インストールを開始できます。

[IMPORTANT]
====
各VMホストが同時にインストールできるゲストは1つだけです。 複数の自動インストールをスケジュールしている場合、前のインストールが完了する前に次のインストールが始まらないようにスケジュールしてください。 ゲストのインストールが別のインストールの実行中に開始すると、実行中のインストールはキャンセルされます。
====


. {productname}の{webui}で、menu:システム[概要]に移動し、ゲストをインストールするVMホストを選択します。
. ［[guiitem]``仮想化``］タブ、［[guimenu]``プロビジョニング``］サブタブに移動します。
. 使用する自動インストールプロファイルを選択し、ゲストの一意の名前を指定します。
. 該当する場合にはプロキシを選択し、スケジュールを入力します。
. ゲストのハードウェアのプロファイルおよび設定オプションを変更するには、［btn:[高度なオプション]］をクリックします。
. ［btn:[自動インストールをスケジュールしてから終了する]］をクリックして完了します。



== VMゲストの管理


{productname}の{webui}を使用して、CPUやメモリの割り当て調整、シャットダウン、再起動のようなアクションなど、VMゲストを管理できます。

そのためには、XenまたはKVM VMホストを{productname}サーバに登録し、[daemon]``libvirtd``サービスをホストで実行する必要があります。 従来のクライアントでは、[package]``mgr-cfg-actions``パッケージを{productname}サーバにインストールする必要もあります。

{productname}の{webui}で、menu:システム[システム一覧]に移動し、管理するゲストのVMホストをクリックします。 ［[guimenu]``仮想化``］タブに移動し、このホストに登録されているすべてのゲストを表示し、管理機能にアクセスします。

{webui}を使用してVMゲストを管理する方法の詳細については、xref:reference:systems/system-details/sd-virtualization.adoc[]を参照してください。
