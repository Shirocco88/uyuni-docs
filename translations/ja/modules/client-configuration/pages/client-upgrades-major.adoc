[[client-upgrades-major]]
= クライアント - メジャーバージョンのアップグレード

クライアントには、インストールされているオペレーティングシステムで利用できる最新のサービスパック(SP)があり、最新の更新がすべて適用されている必要があります。 システムが最新でありすべての更新が正しくインストールされていることを開始前に確認してください。

アップグレードは、{yast}および{ay}によって制御されます。Zypperは使用しません。


== マイグレーションの準備

クライアントをSLE{nbsp}12からSLE{nbsp}15{nbsp}に移行する前に、次の作業を行う必要があります。

. インストールメディアの準備
. Create an auto-installable distribution
. アクティベーションキーの作成
. {ay}プロファイルのアップロード



.プロシージャ: インストールメディアの準備
. {productname}サーバで、SLE{nbsp}15{nbsp}SP2インストールメディア用にローカルディレクトリを作成します。
+
----
mkdir -p /srv/images/sle15sp2
----
. インストールソースでISOイメージをダウンロードし、ISOイメージをサーバにマウントします。
+
----
mount -o loop DVD1.iso /mnt/
----
. マウントしたISOからローカルファイルシステムにすべてコピーします。
+
----
cp -r /mnt/* /srv/images/sle15sp2
----
. コピーが完了したら、ISOイメージをアンマウントします。
+
----
umount /mnt
----

[NOTE]
====
This image is the unified installer and can be used for multiple autoinstallable distributions.
====



.手順: 自動インストール可能なディストリビューションの作成
. {productname}の{webui}で、menu:システム[自動インストール > ディストリビューション]に移動し、［btn:[ディストリビューションの作成]］をクリックします。
. ［[guimenu]``自動インストール可能なディストリビューションの作成``］セクションで、次のパラメータを使用します。
* ［[guimenu]``ディストリビューションラベル``］セクションに、ディストリビューションの固有の名前を入力します。
    半角の英字、数字、ハイフン、ピリオド、および下線のみを使用し、5文字以上にします。 たとえば、``sles15sp2-x86_64``です。
* ［[guimenu]``ツリーパス``］フィールドに、インストールソースへの絶対パスを入力します。
    たとえば、[path]``/srv/images/sle15sp2``です。
* ［[guimenu]``ベースチャンネル``］フィールドで、[systemitem]``SLE-Product-SLES15-SP2-Pool for x86_64``を選択します。
* ［[guimenu]``インストーラ生成``］フィールドで、［[systemitem]``SUSE Linux Enterprise 15``］を選択します。
* ［[guimenu]``カーネルオプション``］フィールドに、インストールでブート時にカーネルに渡すオプションを入力します。
    [option]``install=``パラメータおよび[option]``self_update=0 pt.options=self_update``パラメータはデフォルトで追加されます。
* インストールしたシステムを初めてブートするときにカーネルに渡すオプションを［[guimenu]``カーネルの後のオプション``］セクションに入力します。
. ［btn:[自動インストール可能なディストリビューションの作成]］をクリックして保存します。


古いSLE{nbsp}12{nbsp}ベースチャンネルから新しいSLE{nbsp}15チャンネルに切り替えるには、アクティベーションキーが必要です。



.プロシージャ: アクティベーションキーの作成
. {productname}サーバの{webui}で、menu:システム[アクティベーションキー]に移動し、［[guimenu]``キーの作成``］をクリックします。
. キーの説明を入力します。
. キーを入力するか空白のままにし、自動キーを生成します。
. オプション: 使用量を制限する場合、［[guimenu]``使用量``］テキストフィールドに値を入力します。
. [systemitem]``SLE-Product-SLES15-SP2-Pool for x86_64``ベースチャンネルを選択します。
. オプション: ［[guimenu]``付属エンタイトルメント``］を選択します。
    詳細については、https://documentation.suse.com/sles/15-SP2/html/SLES-all/art-modules.htmlを参照してください。
. ［btn:[アクティベーションキーの作成]］をクリックします。
. ［[guimenu]``子チャンネル``］タブをクリックし、必要なチャンネルを選択します。
. ［btn:[キーの更新]］をクリックします。



== 自動インストールプロファイルの作成

自動インストールプロファイルには、システムをインストールするために必要なインストールデータおよび設定データがすべて含まれています。 インストール完了後に実行するスクリプトを含めることもできます。 手始めに使用できるスクリプトのサンプルは、https://github.com/SUSE/manager-build-profiles/tree/master/AutoYaSTを参照してください。 有効なAutoYaSTアップグレード設定は、https://doc.opensuse.org/projects/autoyast/#CreateProfile-upgradeを参照してください。



.プロシージャ: 自動インストールプロファイルの作成
. {productname}の{webui}で、menu:システム[自動インストール > プロファイル]に移動し、自動インストールプロファイルのスクリプトをアップロードします。
    手始めに使用できるスクリプトのサンプルは、https://github.com/SUSE/manager-build-profiles/tree/master/AutoYaSTを参照してください。
. ［``カーネルオプション``］フィールドに``autoupgrade=1``と入力します。
    ``Y2DEBUG=1``オプションを含めることもできます。 デバッグ設定は不要ですが、問題が発生したときの調査に役立ちます。
. 自動インストールプロファイルを貼り付けるか、またはファイルアップロードフィールドを使用します。
. ［btn:[作成]］をクリックして保存します。
. アップロードしたプロファイルで変数を設定する必要がある場合、menu:システム[自動インストール > プロファイル]に移動し、編集するプロファイルを選択し、［[guimenu]``変数``］タブに移動します。
    次のフォーマットを使用して必要な変数を指定します。
+
----
<key>=<value>
----



== 移行

自動インストールプロファイルで参照するチャンネルがすべて使用可能で完全に同期していることを開始前に確認してください。

[path]``/var/log/rhn/reposync/<channel-label>.log``でミラーリングの進捗状況を監視できます。



.プロシージャ: 移行
. {productname}サーバの{webui}で、［[guimenu]``システム``］に移動し、アップグレードするクライアントを選択します。
. ［[guimenu]``プロビジョニング``］タブに移動し、アップロードした自動インストールプロファイルを選択します。
. ［btn:[自動インストールをスケジュールしてから終了する]］をクリックします。 システムによって、必要なファイルがダウンロードされ、ブートローダのエントリが変更され、再起動され、アップグレードが開始されます。


クライアントは、{productname}サーバと次に同期するときに、再インストールジョブを受け取ります。 再インストールジョブは、新しいカーネルパッケージおよびinitrdパッケージをフェッチします。 また、新しいカーネルパッケージおよびinitrdパッケージへのポインタを含む新しい[path]``/boot/grub/menu.lst``を書き込みます。

クライアントが次にブートするとき、grubを使用して、新しいカーネルとそのinitrdをブートします。 PXEブートはこのプロセス中に使用されません。

ジョブがフェッチされた約3分後に、クライアントは再起動するためにシャットダウンします。

[NOTE]
====
Saltクライアントでは、移行が完了した後、``spacewalk/minion_script``スニペットを使用してクライアントを再登録します。
====
