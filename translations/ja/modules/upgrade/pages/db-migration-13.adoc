[[db-migration-13]]
= Database Migration from Version 10 or 12 to 13

This section covers upgrading the PostgreSQL database from version{nbsp}10 or version{nbsp}12 to version{nbsp}13. If you are already using PostgreSQL 13, you do not need to perform this migration. If you are using an older version, such as version 9.6, see xref:upgrade:db-migration-10.adoc[].

最新バージョンの{productname}にアップグレードする場合、基盤となるオペレーティングシステムに応じて、PostgreSQLバージョン12または13を使用する必要があります。

* SLES 15 SP3を実行している場合、PostgreSQL 13を使用します。
* Leap 15.2を実行している場合、PostgreSQL 12を使用します。



[[db-migration-13-prepare]]
== アップグレードの準備

アップグレードを開始する前に、既存の{productname}サーバを準備して、データベースのバックアップを作成します。

PostgreSQLは[path]``/var/lib/pgsql/data/``にデータを保存します。



.プロシージャ: アップグレードの準備
. アクティブなPostgreSQLのバージョンを確認します。
+
----
psql --version
----
+
If you are using PostgreSQL{nbsp}10 or 12, you can upgrade to PostgreSQL{nbsp}13. If you are already using PostgreSQL version 13, you do not need to perform this migration.
. アクティブなsmdbaのバージョンを確認します。
+
----
rpm -q smdba
----
+
PostgreSQL{nbsp}13では``smdba``のバージョン1.7.6以降が必要です。
. データベースのバックアップを実行します。 バックアップの詳細については、xref:administration:backup-restore.adoc[]を参照してください。



[[db-migration-13-upgrade]]
== PostgreSQLのアップグレード

[WARNING]
====
移行を実行する前に、必ずデータベースのバックアップを作成してください。
====

PostgreSQLのアップグレードは、通常のアップグレードと高速アップグレードの2つの方法で実行できます。

通常のアップグレードでは、データベースの完全なコピーが作成されるため、既存のデータベースサイズの2倍の使用可能容量が必要になります。 通常のアップグレードは、データベースのサイズおよびストレージシステムの速度に応じて、長時間を要する場合があります。

高速アップグレードには数分しかかからず、追加のディスク容量はほぼ不要です。 しかし、高速アップグレードが失敗すると、データベースをバックアップから復元する必要があります。 高速アップグレードでは、ディスク容量を使い果たすリスクが軽減されますが、バックアップが存在しないまたは復元できないときにデータを失うリスクが高まります。 通常のアップグレードでは、ファイル間のハードリンクを作成する代わりに、データベースファイルをコピーします。

PostgreSQLは[path]``/var/lib/pgsql/data/``にデータを保存します。



.プロシージャ: 通常のアップグレードの実行
. データベースのバックアップを実行します。 バックアップの詳細については、xref:administration:backup-restore.adoc[]を参照してください。
. Start the upgrade. If you have version 12, run:
+
----
/usr/lib/susemanager/bin/pg-migrate-12-to-13.sh
----
+
  If you have version 10, run:
+
----
/usr/lib/susemanager/bin/pg-migrate-10-to-13.sh
----
. When the upgrade has successfully completed, you can safely delete the old database directory and reclaim lost disk space. The old directory is renamed to [path]``/var/lib/pgsql/data-pg12`` or [path]``/var/lib/pgsql/data-pg10``, depending on the version you started from.

The [path]``pg-migrate-12-to-13.sh`` or [path]``pg-migrate-10-to-13.sh`` script performs these operations:

* spacewalkサービスを停止する
* 実行中のデータベースをシャットダウンする
* PostgreSQL{nbsp}13がインストールされているかどうかを確認し、必要に応じてインストールする
* Switch from previous version of PostgreSQL{nbsp} to PostgreSQL{nbsp}13 as the new default
* データベースの移行を開始する
* {productname}による使用に合わせて調整されたPostgreSQL設定ファイルを作成する
* データベースおよびspacewalkのサービスを開始する

[NOTE]
====
アップグレードが失敗すると、移行スクリプトは、データベースを元の状態に復元しようとします。
====



.プロシージャ: PostgreSQLの高速アップグレードの実行
. データベースのバックアップを実行します。 確認済みのデータベースのバックアップがない場合、高速アップグレードを開始しないでください。 バックアップの詳細については、xref:administration:backup-restore.adoc[]を参照してください。
. Start the upgrade. If you are migrating from version 12:
+
----
/usr/lib/susemanager/bin/pg-migrate-12-to-13.sh fast
----
+  If you are migrating from version 10:
+
----
/usr/lib/susemanager/bin/pg-migrate-10-to-13.sh fast
----
. When the upgrade has successfully completed, you can safely delete the old database directory and reclaim lost disk space. The old directory is renamed to [path]``/var/lib/pgsql/data-pg12`` or [path]``/var/lib/pgsql/data-pg10``, depending on the version you started from..
